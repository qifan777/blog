import{_ as i}from"./image-4-PU0izJ5K.js";import{_ as k}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as u,o as r,c as d,d as n,e as s,b as o,w as a,a as l}from"./app---xxlxS0.js";const m={},v=l('<h1 id="提交订单" tabindex="-1"><a class="header-anchor" href="#提交订单"><span>提交订单</span></a></h1><figure><img src="'+i+`" alt="订单创建（图1）" height="500" tabindex="0" loading="lazy"><figcaption>订单创建（图1）</figcaption></figure><p>页面：<em>box-order-create.vue</em></p><h2 id="表设计" tabindex="-1"><a class="header-anchor" href="#表设计"><span>表设计</span></a></h2><p>从创建订单的页面中可以分成三类信息</p><ol><li>盲盒信息，购买的盲盒id以及盲盒数量。</li><li>通用信息，地址/优惠券/备注/物流信息（发货后显示）</li><li>价格计算，vip优惠/优惠券优惠/邮费/商品总价/实付金额</li></ol><h3 id="盲盒订单" tabindex="-1"><a class="header-anchor" href="#盲盒订单"><span>盲盒订单</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> mystery_box_order
<span class="token punctuation">(</span>
    id            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
    created_time  <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    edited_time   <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    creator_id    <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    editor_id     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">status</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;订单状态&#39;</span><span class="token punctuation">,</span>
    base_order_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;基础订单id&#39;</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">&#39;盲盒订单&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果有做购物车功能，一次性可能会购买多个盲盒，每个盲盒的数量不一样。这样的需求就需要一个中间表来关联订单和盲盒的关系。</p><p>设计订单时要考虑到盲盒信息会发生变动，因此要把购买时的盲盒信息存入到数据库（盲盒快照），而不是只存储盲盒id。如果存储的是盲盒id，通过关联查询得到是最新的盲盒信息，而不是下单时的信息。</p><p>只有在支付成功后才会显示开盲盒得到的商品，同样也是存储商品快照。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> mystery_box_order_item
<span class="token punctuation">(</span>
    id                   <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
    created_time         <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    edited_time          <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    creator_id           <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    editor_id            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    mystery_box_id       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;盲盒id&#39;</span><span class="token punctuation">,</span>
    mystery_box          json        <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;盲盒信息&#39;</span><span class="token punctuation">,</span>
    mystery_box_order_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;盲盒订单id&#39;</span><span class="token punctuation">,</span>
    mystery_box_count    <span class="token keyword">int</span>         <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;盲盒数量&#39;</span><span class="token punctuation">,</span>
    products             json        <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;开盲盒得到的商品&#39;</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">&#39;盲盒订单项&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基础订单" tabindex="-1"><a class="header-anchor" href="#基础订单"><span>基础订单</span></a></h3><p>基础订单是各种订单里面抽出来的通用字段组合成的一张表，并且关联了支付的详情信息，因为支付本身也是一种通用的信息。</p><p>基础订单里面存储的是地址的快照，而不是地址id。之所以能存储优惠券id是因为优惠券一般不会修改，只会作废下线再生成新的优惠券。</p>`,15),b=n("code",null,"type",-1),g=l(`<p>除了理解字段外，可空性也比较重要。像有些订单不需要发货走线下自然就不会用到地址信息和物流单号，有些订单不需要优惠券，但是支付信息是必须要的。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> base_order
<span class="token punctuation">(</span>
    id              <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
    created_time    <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    edited_time     <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    creator_id      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    editor_id       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    payment_id      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;支付订单id&#39;</span><span class="token punctuation">,</span>
    address         <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;地址详情&#39;</span><span class="token punctuation">,</span>
    remark          <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>  <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;备注&#39;</span><span class="token punctuation">,</span>
    tracking_number <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>   <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;物流单号&#39;</span><span class="token punctuation">,</span>
    coupon_user_id  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>   <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;用户优惠券id&#39;</span><span class="token punctuation">,</span>
    <span class="token keyword">type</span>            <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>   <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;订单类型&#39;</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">&#39;基础订单&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="支付详情" tabindex="-1"><a class="header-anchor" href="#支付详情"><span>支付详情</span></a></h3><p>支付详情在创建订单的时候就有了，此时支付时间和外系统交易订单号还是为空的状态。</p><p>用户在小程序中发起支付后，微信支付收到金额再调用我们的后台。在我们的后台中收到微信回调的请求，并用私钥解密请求得到订单id，再更新订单状态和支付信息。</p><p>支付方式在这个项目中只用到了微信支付。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> payment
<span class="token punctuation">(</span>
    id             <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span>
        <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span>
    created_time   <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    edited_time    <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    creator_id     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    editor_id      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    pay_type       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;支付方式（微信，支付宝等）&#39;</span><span class="token punctuation">,</span>
    pay_time       <span class="token keyword">datetime</span>       <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;支付时间&#39;</span><span class="token punctuation">,</span>
    pay_amount     <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;实付金额&#39;</span><span class="token punctuation">,</span>
    vip_amount     <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;vip优惠金额&#39;</span><span class="token punctuation">,</span>
    coupon_amount  <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;优惠券优惠金额&#39;</span><span class="token punctuation">,</span>
    product_amount <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;商品总价&#39;</span><span class="token punctuation">,</span>
    delivery_fee   <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;邮费&#39;</span><span class="token punctuation">,</span>
    trade_no       <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span>    <span class="token boolean">null</span> <span class="token keyword">comment</span> <span class="token string">&#39;外系统交易订单号&#39;</span>
<span class="token punctuation">)</span>
    <span class="token keyword">comment</span> <span class="token string">&#39;支付详情&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="地址选择" tabindex="-1"><a class="header-anchor" href="#地址选择"><span>地址选择</span></a></h2>`,8),y=n("code",null,"from",-1),h=n("p",null,[s("当用户在地址列表页选择完后，地址列表页会发送"),n("code",null,"address"),s("事件，该事件携带了用户选择的地址详情。因此需要在当前页面监听"),n("code",null,"address"),s("事件。")],-1),f=n("div",{class:"language-html line-numbers-mode","data-ext":"html","data-title":"html"},[n("pre",{class:"language-html"},[n("code",null,[n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order-create"),n("span",{class:"token punctuation"},'"')]),s(),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("payment"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell-group")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("cells"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(`
          `),n("span",{class:"token attr-name"},"is-link"),s(`
          `),n("span",{class:"token attr-name"},"center"),s(`
          `),n("span",{class:"token attr-name"},"@click"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("switchPage('/pages/address/address-list?from=order')"),n("span",{class:"token punctuation"},'"')]),s(`
        `),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#icon"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("image")]),s(`
              `),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("icon"),n("span",{class:"token punctuation"},'"')]),s(`
              `),n("span",{class:"token attr-name"},"src"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("@/assets/icons/local.png"),n("span",{class:"token punctuation"},'"')]),s(`
              `),n("span",{class:"token attr-name"},"mode"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("widthFix"),n("span",{class:"token punctuation"},'"')]),s(`
            `),n("span",{class:"token punctuation"},">")]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("image")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#title"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("address-row")]),s(`
              `),n("span",{class:"token attr-name"},":address"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("chosenAddress"),n("span",{class:"token punctuation"},'"')]),s(`
              `),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("chosenAddress"),n("span",{class:"token punctuation"},'"')]),s(`
            `),n("span",{class:"token punctuation"},">")]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("address-row")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),s(),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("!chosenAddress"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(" 请选择地址"),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#link"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("rect-right")]),n("span",{class:"token punctuation"},">")]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("rect-right")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell-group")]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
`),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),_=n("p",null,[s("监听"),n("code",null,"address"),s("事件将地址详情赋值给"),n("code",null,"chosenAddress"),s("。由于地址会影响运费，调用"),n("code",null,"calculate"),s("重新"),n("a",{href:"#%E8%AE%A1%E7%AE%97%E4%BB%B7%E6%A0%BC"},"计算价格")],-1),w=n("div",{class:"language-typescript line-numbers-mode","data-ext":"ts","data-title":"ts"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"type"),s(),n("span",{class:"token class-name"},"Address"),s(),n("span",{class:"token operator"},"="),s(" AddressDto"),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},'"AddressRepository/COMPLEX_FETCHER_FOR_FRONT"'),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"const"),s(" chosenAddress "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token generic-function"},[n("span",{class:"token function"},"ref"),n("span",{class:"token generic class-name"},[n("span",{class:"token operator"},"<"),s("Address"),n("span",{class:"token operator"},">")])]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
Taro`),n("span",{class:"token punctuation"},"."),s("eventCenter"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"on"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"address"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),s("value"),n("span",{class:"token operator"},":"),s(" Address"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token punctuation"},"{"),s(`
  chosenAddress`),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(" value"),n("span",{class:"token punctuation"},";"),s(`
  order`),n("span",{class:"token punctuation"},"."),s("value"),n("span",{class:"token punctuation"},"."),s("baseOrder"),n("span",{class:"token punctuation"},"."),s("addressId "),n("span",{class:"token operator"},"="),s(" value"),n("span",{class:"token punctuation"},"."),s("id"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),x=n("h2",{id:"优惠券选择",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#优惠券选择"},[n("span",null,"优惠券选择")])],-1),A=n("code",null,"amount",-1),B=n("code",null,"id",-1),E=n("p",null,[s("当用户在优惠券列表页选择完后，优惠券列表页会发送"),n("code",null,"coupon"),s("事件，该事件携带了用户选择的优惠券详情，因此需要在当前页面监听"),n("code",null,"coupon"),s("事件。")],-1),O=n("div",{class:"language-html line-numbers-mode","data-ext":"html","data-title":"html"},[n("pre",{class:"language-html"},[n("code",null,[n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order-create"),n("span",{class:"token punctuation"},'"')]),s(),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("payment"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell-group")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("cells"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(`
          `),n("span",{class:"token attr-name"},"is-link"),s(`
          `),n("span",{class:"token attr-name"},"center"),s(`
          `),n("span",{class:"token attr-name"},"@click"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("\n            switchPage(\n              `/pages/coupon/index?amount=${payment.productAmount}&id=${chosenCoupon?.id}`,\n            )\n          "),n("span",{class:"token punctuation"},'"')]),s(`
        `),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#icon"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("image")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("icon"),n("span",{class:"token punctuation"},'"')]),s(),n("span",{class:"token attr-name"},"src"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("@/assets/icons/coupon.png"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("image")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#title"),n("span",{class:"token punctuation"},">")]),s(`
            {{ chosenCoupon?.coupon.name }}
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),s(),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("!chosenCoupon"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(" 请选择优惠券 "),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#link"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("rect-right")]),n("span",{class:"token punctuation"},">")]),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("rect-right")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell-group")]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
`),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),q=n("p",null,[s("监听"),n("code",null,"coupon"),s("事件将地址详情赋值给"),n("code",null,"chosenCoupon"),s("。由于优惠券会影响价格，调用"),n("code",null,"calculate"),s("重新"),n("a",{href:"#%E8%AE%A1%E7%AE%97%E4%BB%B7%E6%A0%BC"},"计算价格")],-1),I=n("div",{class:"language-typescript line-numbers-mode","data-ext":"ts","data-title":"ts"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"type"),s(),n("span",{class:"token class-name"},"CouponUserRel"),s(),n("span",{class:"token operator"},"="),s(`
  CouponUserRelDto`),n("span",{class:"token punctuation"},"["),n("span",{class:"token string"},'"CouponUserRelRepository/COMPLEX_FETCHER_FOR_FRONT"'),n("span",{class:"token punctuation"},"]"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"const"),s(" chosenCoupon "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token generic-function"},[n("span",{class:"token function"},"ref"),n("span",{class:"token generic class-name"},[n("span",{class:"token operator"},"<"),s("CouponUserRel"),n("span",{class:"token operator"},">")])]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
Taro`),n("span",{class:"token punctuation"},"."),s("eventCenter"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"on"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"coupon"'),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token punctuation"},"("),s("couponUserRel"),n("span",{class:"token operator"},"?"),n("span",{class:"token operator"},":"),s(" CouponUserRel"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token punctuation"},"{"),s(`
  chosenCoupon`),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(" couponUserRel"),n("span",{class:"token punctuation"},";"),s(`
  order`),n("span",{class:"token punctuation"},"."),s("value"),n("span",{class:"token punctuation"},"."),s("baseOrder"),n("span",{class:"token punctuation"},"."),s("couponUserId "),n("span",{class:"token operator"},"="),s(" couponUserRel"),n("span",{class:"token operator"},"?."),s("id"),n("span",{class:"token punctuation"},";"),s(`
  `),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),C=n("h2",{id:"计算价格",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#计算价格"},[n("span",null,"计算价格")])],-1),P=n("li",null,"累加盲盒价格得到商品总价",-1),R=n("div",{class:"language-html line-numbers-mode","data-ext":"html","data-title":"html"},[n("pre",{class:"language-html"},[n("code",null,[n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order-create"),n("span",{class:"token punctuation"},'"')]),s(),n("span",{class:"token attr-name"},"v-if"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("payment"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("box-order"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
      `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell-group")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("summary"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(),n("span",{class:"token attr-name"},"title"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("盲盒总价"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("value"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s("￥{{ payment.productAmount }}"),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(),n("span",{class:"token attr-name"},"title"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("运费"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("value"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s("￥{{ payment.deliveryFee }}"),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(),n("span",{class:"token attr-name"},"title"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("优惠券"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("value"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s("-￥{{ payment.couponAmount }}"),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("nut-cell")]),s(),n("span",{class:"token attr-name"},"title"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("会员优惠"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("template")]),s(),n("span",{class:"token attr-name"},"#desc"),n("span",{class:"token punctuation"},">")]),s(`
            `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"<"),s("div")]),s(),n("span",{class:"token attr-name"},"class"),n("span",{class:"token attr-value"},[n("span",{class:"token punctuation attr-equals"},"="),n("span",{class:"token punctuation"},'"'),s("value"),n("span",{class:"token punctuation"},'"')]),n("span",{class:"token punctuation"},">")]),s("-￥{{ payment.vipAmount }}"),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
          `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
        `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell")]),n("span",{class:"token punctuation"},">")]),s(`
      `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("nut-cell-group")]),n("span",{class:"token punctuation"},">")]),s(`
      `),n("span",{class:"token comment"},"<!-- 忽略... -->"),s(`
    `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
  `),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("div")]),n("span",{class:"token punctuation"},">")]),s(`
`),n("span",{class:"token tag"},[n("span",{class:"token tag"},[n("span",{class:"token punctuation"},"</"),s("template")]),n("span",{class:"token punctuation"},">")]),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),D=n("div",{class:"language-typescript line-numbers-mode","data-ext":"ts","data-title":"ts"},[n("pre",{class:"language-typescript"},[n("code",null,[n("span",{class:"token keyword"},"const"),s(" payment "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token generic-function"},[n("span",{class:"token function"},"ref"),n("span",{class:"token generic class-name"},[n("span",{class:"token operator"},"<"),s("PaymentPriceView"),n("span",{class:"token operator"},">")])]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token keyword"},"const"),s(),n("span",{class:"token function-variable function"},"calculate"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"async"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"=>"),s(),n("span",{class:"token punctuation"},"{"),s(`
  payment`),n("span",{class:"token punctuation"},"."),s("value "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"await"),s(" api"),n("span",{class:"token punctuation"},"."),s("mysteryBoxOrderForFrontController"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"{"),s(`
    body`),n("span",{class:"token operator"},":"),s(" order"),n("span",{class:"token punctuation"},"."),s("value"),n("span",{class:"token punctuation"},","),s(`
  `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),T=n("p",null,[n("code",null,"MysteryBoxOrderService")],-1),j=n("div",{class:"language-java line-numbers-mode","data-ext":"java","data-title":"java"},[n("pre",{class:"language-java"},[n("code",null,[s("    "),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token class-name"},"PaymentPriceView"),s(),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"MysteryBoxOrderInput"),s(" mysteryBoxOrderInput"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"var"),s(" baseOrder "),n("span",{class:"token operator"},"="),s(" mysteryBoxOrderInput"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getBaseOrder"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token class-name"},"Payment"),s(" produce "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"PaymentDraft"),n("span",{class:"token punctuation"},"."),s("$"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"produce"),n("span",{class:"token punctuation"},"("),s("draft "),n("span",{class:"token operator"},"->"),s(),n("span",{class:"token punctuation"},"{"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setProductAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"ZERO"),n("span",{class:"token punctuation"},")"),s(`
                    `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setDeliveryFee"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"ZERO"),n("span",{class:"token punctuation"},")"),s(`
                    `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setVipAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"ZERO"),n("span",{class:"token punctuation"},")"),s(`
                    `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setCouponAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"ZERO"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token class-name"},"BigDecimal"),s(" totalPrice "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"ZERO"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"var"),s(" item "),n("span",{class:"token operator"},":"),s(" mysteryBoxOrderInput"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getItems"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token class-name"},"MysteryBox"),s(" mysteryBox "),n("span",{class:"token operator"},"="),s(" mysteryBoxRepository"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"findById"),n("span",{class:"token punctuation"},"("),s("item"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getMysteryBoxId"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
                        `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"orElseThrow"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"->"),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"BusinessException"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},[s("ResultCode"),n("span",{class:"token punctuation"},"."),s("NotFindError")]),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token string"},'"盲盒不存在"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token class-name"},"BigDecimal"),s(" price "),n("span",{class:"token operator"},"="),s(" mysteryBox"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"price"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"multiply"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"BigDecimal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"valueOf"),n("span",{class:"token punctuation"},"("),s("item"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getMysteryBoxCount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                totalPrice `),n("span",{class:"token operator"},"="),s(" totalPrice"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"add"),n("span",{class:"token punctuation"},"("),s("price"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token comment"},"// 计算商品总价"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setProductAmount"),n("span",{class:"token punctuation"},"("),s("totalPrice"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token comment"},"// 计算优惠券"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setCouponAmount"),n("span",{class:"token punctuation"},"("),s("couponService"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),s("baseOrder"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getCouponUserId"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" totalPrice"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token comment"},"// 计算运费"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setDeliveryFee"),n("span",{class:"token punctuation"},"("),s("carriageTemplateService"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),s("baseOrder"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getAddressId"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" totalPrice"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token comment"},"// 计算VIP优惠价格"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setVipAmount"),n("span",{class:"token punctuation"},"("),s("vipService"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"calculate"),n("span",{class:"token punctuation"},"("),s("totalPrice"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token comment"},"// 计算实际支付价格"),s(`
            draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"setPayAmount"),n("span",{class:"token punctuation"},"("),s(`
                    draft`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"productAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(`
                            `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"add"),n("span",{class:"token punctuation"},"("),s("draft"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"deliveryFee"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
                            `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"subtract"),n("span",{class:"token punctuation"},"("),s("draft"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"couponAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
                            `),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"subtract"),n("span",{class:"token punctuation"},"("),s("draft"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"vipAmount"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(`
            `),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"PaymentPriceView"),n("span",{class:"token punctuation"},"("),s("produce"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),F=l(`<h2 id="创建订单" tabindex="-1"><a class="header-anchor" href="#创建订单"><span>创建订单</span></a></h2><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">MysteryBoxOrderInput</span> mysteryBoxOrderInput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> orderId <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">fastSimpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PaymentPriceView</span> calculated <span class="token operator">=</span> <span class="token function">calculate</span><span class="token punctuation">(</span>mysteryBoxOrderInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 支付详情</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token class-name">PaymentDraft</span><span class="token punctuation">.</span>$<span class="token punctuation">.</span><span class="token function">produce</span><span class="token punctuation">(</span>
                calculated<span class="token punctuation">.</span><span class="token function">toEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                paymentDraft <span class="token operator">-&gt;</span> paymentDraft
                        <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setPayType</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span><span class="token constant">WE_CHAT_PAY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Address</span> address <span class="token operator">=</span> addressRepository
                <span class="token punctuation">.</span><span class="token function">findUserAddressById</span><span class="token punctuation">(</span>mysteryBoxOrderInput<span class="token punctuation">.</span><span class="token function">getBaseOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddressId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;地址不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MysteryBoxOrder</span> entity <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">createMysteryBoxOrder</span><span class="token punctuation">(</span>mysteryBoxOrderInput
                        <span class="token punctuation">.</span><span class="token function">toEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                draft <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 设置订单项关联的订单id，并且设置盲盒快照</span>
                    draft<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>draft
                            <span class="token punctuation">.</span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">createMysteryBoxOrderItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> mysteryBoxOrderItemDraft <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                                <span class="token class-name">MysteryBox</span> box <span class="token operator">=</span> mysteryBoxRepository
                                        <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">mysteryBoxId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MysteryBoxRepository</span><span class="token punctuation">.</span><span class="token constant">COMPLEX_FETCHER_FOR_FRONT</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token class-name">ResultCode<span class="token punctuation">.</span>NotFindError</span><span class="token punctuation">,</span> <span class="token string">&quot;盲盒不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                mysteryBoxOrderItemDraft<span class="token punctuation">.</span><span class="token function">setMysteryBoxOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
                                        <span class="token comment">// 盲盒快照，购买时的盲盒详情存入</span>
                                        <span class="token punctuation">.</span><span class="token function">setMysteryBox</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MystryBoxView</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 设置订单的id和状态</span>
                    draft<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">ProductOrderStatus</span><span class="token punctuation">.</span><span class="token constant">TO_BE_PAID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 设置基础订单</span>
                    draft<span class="token punctuation">.</span><span class="token function">baseOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">OrderType</span><span class="token punctuation">.</span><span class="token constant">PRODUCT_ORDER</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setPayment</span><span class="token punctuation">(</span>payment<span class="token punctuation">)</span>
                            <span class="token comment">// 地址快照</span>
                            <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AddressView</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 同时创建mysteryBoxOrder, mysteryBoxOrderItem, baseOrder, payment</span>
        <span class="token class-name">MysteryBoxOrder</span> save <span class="token operator">=</span> mysteryBoxOrderRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 优惠券设置为已使用</span>
        couponService<span class="token punctuation">.</span><span class="token function">changeStatus</span><span class="token punctuation">(</span>mysteryBoxOrderInput<span class="token punctuation">.</span><span class="token function">getBaseOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCouponUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CouponUseStatus</span><span class="token punctuation">.</span><span class="token constant">USED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> save<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2);function M(U,S){const p=u("RouterLink"),c=u("Tabs");return r(),d("div",null,[v,n("p",null,[s("除了盲盒订单之外，"),o(p,{to:"/project/mystery-box/vip.html"},{default:a(()=>[s("VIP订单")]),_:1}),s("也用到了基础订单，所以这边"),b,s("字段可以标识基础订单是来自于哪个业务。")]),g,n("p",null,[s("点选择地址时跳转到"),o(p,{to:"/project/mystery-box/address/address-list.html"},{default:a(()=>[s("地址列表")]),_:1}),s("，并携带参数"),y,s("标识跳转来源。")]),h,o(c,{id:"84",data:[{id:"html"},{id:"ts"}]},{title0:a(({value:t,isActive:e})=>[s("html")]),title1:a(({value:t,isActive:e})=>[s("ts")]),tab0:a(({value:t,isActive:e})=>[f]),tab1:a(({value:t,isActive:e})=>[_,w]),_:1}),x,n("p",null,[s("点选择优惠券时跳转到"),o(p,{to:"/project/mystery-box/coupon/coupon-user.html"},{default:a(()=>[s("优惠券列表")]),_:1}),s("，并携带参数"),A,s("和"),B,s("，详细内容请参考优惠券列表页面。")]),E,o(c,{id:"104",data:[{id:"html"},{id:"ts"}]},{title0:a(({value:t,isActive:e})=>[s("html")]),title1:a(({value:t,isActive:e})=>[s("ts")]),tab0:a(({value:t,isActive:e})=>[O]),tab1:a(({value:t,isActive:e})=>[q,I]),_:1}),C,n("ul",null,[P,n("li",null,[o(p,{to:"/project/mystery-box/coupon/coupon.html#%E4%BC%98%E6%83%A0%E5%88%B8%E8%AE%A1%E7%AE%97"},{default:a(()=>[s("优惠券计算")]),_:1}),s("得到优惠价格")]),n("li",null,[o(p,{to:"/project/mystery-box/carriage-template.html#%E8%BF%90%E8%B4%B9%E8%AE%A1%E7%AE%97"},{default:a(()=>[s("运费计算")]),_:1}),s("得到运费价格")]),n("li",null,[o(p,{to:"/project/mystery-box/vip.html#vip%E6%8A%98%E6%89%A3%E8%AE%A1%E7%AE%97"},{default:a(()=>[s("vip计算")]),_:1}),s("得到vip价格")])]),o(c,{id:"140",data:[{id:"html"},{id:"ts"},{id:"java"}]},{title0:a(({value:t,isActive:e})=>[s("html")]),title1:a(({value:t,isActive:e})=>[s("ts")]),title2:a(({value:t,isActive:e})=>[s("java")]),tab0:a(({value:t,isActive:e})=>[R]),tab1:a(({value:t,isActive:e})=>[D]),tab2:a(({value:t,isActive:e})=>[T,j]),_:1}),F])}const Z=k(m,[["render",M],["__file","box-order-create.html.vue"]]);export{Z as default};
