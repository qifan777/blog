import{_ as e}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as p,o as c,c as o,d as s,e as n,b as l,w as i,a}from"./app-oK_DQ516.js";const u={},d=a(`<h1 id="图片理解" tabindex="-1"><a class="header-anchor" href="#图片理解"><span>图片理解</span></a></h1><h2 id="模型配置" tabindex="-1"><a class="header-anchor" href="#模型配置"><span>模型配置</span></a></h2><p>选择支持图片理解的模型</p><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code>    <span class="token key atrule">dash-scope</span><span class="token punctuation">:</span>
      <span class="token key atrule">api-key</span><span class="token punctuation">:</span> xxx
      <span class="token key atrule">chat</span><span class="token punctuation">:</span>
        <span class="token key atrule">model</span><span class="token punctuation">:</span> qwen<span class="token punctuation">-</span>vl<span class="token punctuation">-</span>plus
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>如果使用的是灵积，需要注入<code>private final DashScopeAiVLChatModel dashScopeAiVLChatModel;</code>。<br> 而不是<code>private final DashScopeAiChatModel dashScopeAiChatModel;</code>要不会报错。</p></div><h2 id="图片上传" tabindex="-1"><a class="header-anchor" href="#图片上传"><span>图片上传</span></a></h2><h3 id="依赖引用" tabindex="-1"><a class="header-anchor" href="#依赖引用"><span>依赖引用</span></a></h3><p>我自己封装了一下阿里云、腾讯云、本地nginx的OSS上传starter</p><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.qifan777<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="oss配置" tabindex="-1"><a class="header-anchor" href="#oss配置"><span>OSS配置</span></a></h3><div class="language-yaml line-numbers-mode" data-ext="yml" data-title="yml"><pre class="language-yaml"><code><span class="token key atrule">oss</span><span class="token punctuation">:</span>
  <span class="token key atrule">provider</span><span class="token punctuation">:</span> ali_yun
  <span class="token comment"># 阿里云oss配置</span>
  <span class="token key atrule">ali-yun</span><span class="token punctuation">:</span>
    <span class="token key atrule">access-key-id</span><span class="token punctuation">:</span> xxx
    <span class="token key atrule">access-key-secret</span><span class="token punctuation">:</span> xxx
    <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>qingdao.aliyuncs.com
    <span class="token key atrule">bucket-name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>community
  <span class="token comment"># 腾讯云oss配置</span>
  <span class="token key atrule">tencent</span><span class="token punctuation">:</span>
    <span class="token key atrule">bucket</span><span class="token punctuation">:</span> wechat<span class="token punctuation">-</span>aaa
    <span class="token key atrule">secret-id</span><span class="token punctuation">:</span> xxx
    <span class="token key atrule">secret-key</span><span class="token punctuation">:</span> xxx
    <span class="token key atrule">region</span><span class="token punctuation">:</span> ap<span class="token punctuation">-</span>beijing
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="图片上传controller" tabindex="-1"><a class="header-anchor" href="#图片上传controller"><span>图片上传Controller</span></a></h3><p>接收前端图片，返回url</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;oss&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OSSController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OSSService</span> ossService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;upload&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ossService<span class="token punctuation">.</span><span class="token function">upload</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="前端上传" tabindex="-1"><a class="header-anchor" href="#前端上传"><span>前端上传</span></a></h3><p>使用<code>image-upload</code>组件，可以快速上传图片</p><div class="language-html line-numbers-mode" data-ext="html" data-title="html"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>image-upload</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>image<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>40<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>message.image<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>image-upload</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="发送媒体-图片-消息" tabindex="-1"><a class="header-anchor" href="#发送媒体-图片-消息"><span>发送媒体（图片）消息</span></a></h2>`,18),r=s("code",null,"medias",-1),k=a(`<div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>  <span class="token comment">// 图片/语音</span>
  <span class="token keyword">const</span> <span class="token literal-property property">medias</span><span class="token operator">:</span> AiMessage<span class="token punctuation">[</span><span class="token string">&#39;medias&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    medias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;image&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> message<span class="token punctuation">.</span>image <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SpringAI的<code>UserMessage</code>支持发送媒体对象，因此只需将接收的<code>medias</code>添加的<code>UserMessage</code>即可。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">toPrompt</span><span class="token punctuation">(</span><span class="token class-name">ChatClient<span class="token punctuation">.</span>PromptUserSpec</span> promptUserSpec<span class="token punctuation">,</span> <span class="token class-name">AiMessageInput</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// AiMessageInput转成Message</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token class-name">AiMessageChatMemory</span><span class="token punctuation">.</span><span class="token function">toSpringAiMessage</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">toEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用户发送的图片/语言</span>
            <span class="token class-name">Media</span><span class="token punctuation">[</span><span class="token punctuation">]</span> medias <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Media</span><span class="token punctuation">[</span>message<span class="token punctuation">.</span><span class="token function">getMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            promptUserSpec<span class="token punctuation">.</span><span class="token function">media</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>medias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 用户发送的文本</span>
        promptUserSpec<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3);function m(v,g){const t=p("RouterLink");return c(),o("div",null,[d,s("p",null,[n("请参考"),l(t,{to:"/project/spring-ai/chat.html"},{default:i(()=>[n("发送消息")]),_:1}),n("，在用户发送消息时，判断是否有图片，如果有，则添加到"),r,n("中。")]),k])}const y=e(u,[["render",m],["__file","vision.html.vue"]]);export{y as default};
