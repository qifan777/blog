import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as a,a as t}from"./app-0nW1dKW7.js";const p={},e=t(`<h1 id="manager构建" tabindex="-1"><a class="header-anchor" href="#manager构建"><span>Manager构建</span></a></h1><h2 id="manager节点" tabindex="-1"><a class="header-anchor" href="#manager节点"><span>Manager节点</span></a></h2><p>使用<code>easy-excel</code>读取<code>form13.csv</code>文件，将数据映射成<code>Manager</code>对象，并保存到数据库中。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Neo4jClient</span> neo4jClient<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> jacksonObjectMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ManagerRepository</span> managerRepository<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Form13</span><span class="token punctuation">&gt;</span></span> <span class="token function">readForm13List</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SyncReadListener</span> syncReadListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncReadListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">EasyExcel</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;F:\\\\workspace\\\\code\\\\learn\\\\sec-edgar-notebooks\\\\data\\\\sample\\\\form13.csv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Form13</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> syncReadListener<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">doRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> syncReadListener<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>o <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">Form13</span><span class="token punctuation">)</span> o<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;nodes&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Form13</span><span class="token punctuation">&gt;</span></span> form13List <span class="token operator">=</span> <span class="token function">readForm13List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 投资方可能投资了多个证券，所以会有重复的投资方记录，去重一下</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cikList <span class="token operator">=</span> form13List<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Form13</span><span class="token operator">::</span><span class="token function">getManagerCik</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 每个cik代表一个投资方，映射成Manager对象</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Manager</span><span class="token punctuation">&gt;</span></span> managerList <span class="token operator">=</span> cikList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>cik <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">Form13</span> manager <span class="token operator">=</span> form13List<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>form13 <span class="token operator">-&gt;</span> form13<span class="token punctuation">.</span><span class="token function">getManagerCik</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>cik<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BusinessException</span><span class="token punctuation">(</span><span class="token string">&quot;投资公司不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Manager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setCik</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">getManagerCik</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">getManagerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">getManagerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        managerRepository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>managerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="manager和company的关联" tabindex="-1"><a class="header-anchor" href="#manager和company的关联"><span>Manager和Company的关联</span></a></h2><p>因为<code>Manager</code>和<code>Company</code>是多对多的关系，<code>form13.csv</code>相当于是中间表，通过它可以创建<code>OWNS_STOCK_IN</code>关系。因此下面我们遍历<code>form13.csv</code>，创建<code>OWNS_STOCK_IN</code>关系。</p><ol><li>根据<code>managerCik</code>和<code>cusip6</code>查询<code>Manager</code>和<code>Company</code>节点</li><li>创建<code>OWNS_STOCK_IN</code>关系，更新或者创建<code>OWNS_STOCK_IN</code>关系，如果已存在，则更新<code>reportCalendarOrQuarter</code></li><li>第一次创建设置关系的<code>value</code>、<code>shares</code>属性</li></ol><p>由于这个<code>Cypher</code>语句需要较多的参数，通过<code>toMap</code>方法将<code>Form13</code>对象转换为<code>Map</code>，然后通过<code>neo4jClient</code>的<code>bindAll</code>方法执行将参数传给<code>Cypher</code>语句。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;relationship/stock-in&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createStockInRelationship</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Form13</span><span class="token punctuation">&gt;</span></span> form13List <span class="token operator">=</span> <span class="token function">readForm13List</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        form13List<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>form13 <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            neo4jClient<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token triple-quoted-string string">&quot;&quot;&quot;
                            match (m:Manager {cik: $managerCik}), (com:Company {cusip6: $cusip6})
                            merge (m)-[owns:OWNS_STOCK_IN {reportCalendarOrQuarter: $reportCalendarOrQuarter}]-&gt;(com)
                            on create set
                                owns.value = $value,
                                owns.shares = $shares
                            &quot;&quot;&quot;</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">bindAll</span><span class="token punctuation">(</span><span class="token function">toMap</span><span class="token punctuation">(</span>form13<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Form13</span> form13<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jacksonObjectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>jacksonObjectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>form13<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,9),o=[e];function c(i,l){return s(),a("div",null,o)}const r=n(p,[["render",c],["__file","manager.html.vue"]]);export{r as default};
